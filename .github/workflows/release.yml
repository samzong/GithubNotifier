name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "SEMVER=${VERSION#v}" >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          brew install swiftformat
          brew install sparkle

      - name: Code Quality Check
        run: make check

      - name: Build DMG Packages
        run: |
          make VERSION=${{ env.VERSION }} dmg

      - name: Verify DMG Files
        run: |
          echo "===> Checking DMG files..."
          ls -lh .build/*.dmg
          
          echo "===> Verifying x86_64 DMG..."
          hdiutil verify .build/GitHubNotifier-x86_64.dmg
          
          echo "===> Verifying arm64 DMG..."
          hdiutil verify .build/GitHubNotifier-arm64.dmg

      - name: Sign DMGs with Sparkle
        env:
          SPARKLE_ED_KEY: ${{ secrets.SPARKLE_ED_KEY }}
        run: |
          # Get sign_update tool path
          SPARKLE_PATH=$(brew --prefix sparkle)
          SIGN_UPDATE="${SPARKLE_PATH}/bin/sign_update"
          
          # Remove quarantine attribute if present
          xattr -cr "${SIGN_UPDATE}" 2>/dev/null || true
          
          echo "===> Signing x86_64 DMG..."
          X86_SIG=$("${SIGN_UPDATE}" .build/GitHubNotifier-x86_64.dmg --ed-key-file <(echo "$SPARKLE_ED_KEY"))
          echo "X86_SIG=${X86_SIG}" >> $GITHUB_ENV
          
          echo "===> Signing arm64 DMG..."
          ARM_SIG=$("${SIGN_UPDATE}" .build/GitHubNotifier-arm64.dmg --ed-key-file <(echo "$SPARKLE_ED_KEY"))
          echo "ARM_SIG=${ARM_SIG}" >> $GITHUB_ENV

      - name: Generate Appcast
        run: |
          # DMG file sizes
          X86_SIZE=$(stat -f%z .build/GitHubNotifier-x86_64.dmg)
          ARM_SIZE=$(stat -f%z .build/GitHubNotifier-arm64.dmg)
          
          # Current date in RFC 2822 format
          PUB_DATE=$(date -R)
          
          # Generate appcast.xml
          cat > .build/appcast.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
            <channel>
              <title>GitHubNotifier Updates</title>
              <link>https://github.com/samzong/GitHubNotifier</link>
              <description>Most recent changes with links to updates.</description>
              <language>en</language>
              
              <!-- Intel (x86_64) -->
              <item>
                <title>Version ${{ env.SEMVER }}</title>
                <pubDate>${PUB_DATE}</pubDate>
                <sparkle:version>${{ env.SEMVER }}</sparkle:version>
                <sparkle:shortVersionString>${{ env.SEMVER }}</sparkle:shortVersionString>
                <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
                <enclosure
                  url="https://github.com/samzong/GitHubNotifier/releases/download/${{ env.VERSION }}/GitHubNotifier-x86_64.dmg"
                  type="application/octet-stream"
                  sparkle:os="macos"
                  length="${X86_SIZE}"
                  ${X86_SIG}
                />
              </item>
              
              <!-- Apple Silicon (arm64) -->
              <item>
                <title>Version ${{ env.SEMVER }}</title>
                <pubDate>${PUB_DATE}</pubDate>
                <sparkle:version>${{ env.SEMVER }}</sparkle:version>
                <sparkle:shortVersionString>${{ env.SEMVER }}</sparkle:shortVersionString>
                <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
                <enclosure
                  url="https://github.com/samzong/GitHubNotifier/releases/download/${{ env.VERSION }}/GitHubNotifier-arm64.dmg"
                  type="application/octet-stream"
                  sparkle:os="macos"
                  length="${ARM_SIZE}"
                  ${ARM_SIG}
                />
              </item>
            </channel>
          </rss>
          EOF
          
          echo "===> Generated appcast.xml:"
          cat .build/appcast.xml

      - name: Generate Release Notes
        id: release_notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Generate GitHub-style release notes using the GitHub CLI
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/releases/generate-notes \
            -f tag_name='${{ env.VERSION }}' > generated_notes.json

          jq -r '.body' generated_notes.json > release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            .build/GitHubNotifier-x86_64.dmg
            .build/GitHubNotifier-arm64.dmg
            .build/appcast.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Homebrew Update
        if: success()
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GH_PAT }}
          event-type: trigger-homebrew-update
          client-payload: '{"version": "${{ env.VERSION }}"}'
